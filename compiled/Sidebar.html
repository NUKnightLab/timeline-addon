<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

  <style>
    /* grunt inline's way of doing things */
    .title {
  font-weight: bold;
  margin-left: 5%;
  font-size: 1em;
}

.headline {
  margin-top: 30px;
  font-weight: bold;
}

input[type='text'] {
  margin-top: 20px;
  width: 80%;
  margin-left: 10%;
  border: none;
  border-bottom: solid 2px #c9c9c9;
  transition: all .2s ease;
}

input[type='text']:focus{
  -webkit-box-shadow: none;
  border: none;
  border-bottom: solid 2px #969696;
}

.headline input[type='text']{
  font-size: 2em;
  height: 2em;
}

.dates {
  margin-left: 10%;
  width: 80%;
}

.dates h3 {
  display: inline;
  margin-right: 2%;
  color: #969696;
  width: 10%;
}

.dates input {
  width: 18%;
  margin-left: 0;
}

.dates-fields {
  display: inline-block;
  margin-bottom: 10px;
}

.dates-fields span {
  width: 79px;
}

.dates-fields span h3{
  font-size: 12px;
}

.dates-fields select {
  min-width: 50px;
}

.display-date input[type='text'] {
  font-size: 1em;
  height: 2em;
}

#submit-bar{
  margin-top: 20px;
  margin-bottom: 20px;
  text-align: center;
}

.edit-modes div {
  display: inline-block;
  width: 49.4%;
  height: 40px;
  text-align: center;
  line-height: 50px;
  border-bottom: 3px solid #E0E0E0;
  transition: all .2s ease;
}

.edit-modes div:hover,
.edit-modes div.current-mode{
  background-color: #E0E0E0;
  border-bottom: 3px solid #9E9E9E;
  cursor: pointer;
}

.refresh-rows {
  text-align: center;
  margin-top: 20px;
}

.row-select {
  font-weight: bold;
  margin-left: 10%;
  margin-bottom: 0;
}

.edit-select {
  height: 110px;
  overflow-y: scroll;
  width: 90%;
}

.edit-select-list li{
  list-style-type: none;
  transition: all .2s ease;
  border-left: 4px solid #e0e0e0;
  padding-left: 4px;
}

.edit-select-list li:hover{
  background-color: #E0E0E0;
  cursor: pointer;
  border-left: 4px solid #9e9e9e;
}

.edit-select-list li.selected{
  background-color: #E0E0E0;
  cursor: pointer;
  border-left: 4px solid #9e9e9e;
}

  </style>

</head>

<body>
  <form>
    <h4 class='row-select edit-event-element'>Row Select</h4>
    <div class="edit-select edit-event-element">
      <ul class='edit-select-list'>
      </ul>
    </div>
    <div class='headline'>
      <input type='text' name='headline' placeholder='Headline' class='optional'>
    </div>
    <div class='text'>
      <input type='text' name='text' placeholder='Text' class='optional'>
    </div>
    <div class='dates'>
      <div class='dates-fields'>
        <span>
          <h3>Start Date</h3>
        </span>
        <input type='text' name='start-year' placeholder='YYYY' class='required'> /
        <input type='text' name='start-month' placeholder='MM' class='optional-num'> /
        <input type='text' name='start-day' placeholder='DD' class='optional-num'>
      </div>
      <div class='dates-fields'>
        <span>
          <h3>Start Time</h3>
        </span>
        <select name='start-hour' class='select-hour'>
          <option value=''>HH</option>
        </select>
        <select name='start-minute' class='select-minute'>
          <option value=''>MM</option>
        </select>
        <select name='start-second' class='select-second'>
          <option value=''>SS</option>
        </select>
      </div>
    </div>
    <div class='dates'>
      <div class='dates-fields'>
        <span>
          <h3>End Date</h3>
        </span>
        <input type='text' name='end-year' placeholder='YYYY' class='optional-num'> /
        <input type='text' name='end-month' placeholder='MM' class='optional-num'> /
        <input type='text' name='end-day' placeholder='DD' class='optional-num'>
      </div>
      <div class='dates-fields'>
        <span>
          <h3>End Time</h3>
        </span>
        <select name='end-hour' class='select-hour'>
          <option value=''>HH</option>
        </select>
        <select name='end-minute' class='select-minute'>
          <option value=''>MM</option>
        </select>
        <select name='end-second' class='select-second'>
          <option value=''>SS</option>
        </select>
      </div>
    </div>
    <div class='display-date'>
      <input type='text' name='display-date' placeholder='Display Date' class='optional'>
    </div>
    <div class='media-link'>
      <input type='text' name='media' placeholder='Media Link' class='optional'>
    </div>
    <div class='media-credit'>
      <input type='text' name='media-credit' placeholder='Media Credit' class='optional'>
    </div>
    <div class='media-caption'>
      <input type='text' name='media-caption' placeholder='Media Caption' class='optional'>
    </div>
    <div class='media-thumb'>
      <input type='text' name='media-thumb' placeholder='Media Thumbnail' class='optional'>
    </div>
    <div class='type'>
      <input type='text' name='type' placeholder='Type' class='optional'>
    </div>
    <div class='group'>
      <input type='text' name='group' placeholder='Group' class='optional'>
    </div>
    <div class='background'>
      <input type='text' name='background' placeholder='Background' class='optional'>
    </div>
    <div id='submit-bar'>
      <input type='submit' value='Add Event' id='add-event' class='new-event-element'>
    </div>
  </form>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
    // grunt inline's way of doing things
    var gray = "#c9c9c9",
    darkgray = '#969696',
    green = "#00C853",
    red = "#F44336";

var currentRowID;

  $(document).ready(function() {
    // refresh row list automatically
    setInterval(function() {
      getAllRows();
      // kind of works but not really
      $('.edit-select-list').find('#' + currentRowID).addClass('selected');
    }, 3000);

    for(var i = 0; i < 24; i++) {
      if (i < 10) {
        i = ("0" + i).slice(-2);
      }

      $('.select-hour').append('<option value="' + i + '">' + i + '</option>');
    }

    for(var i = 0; i < 60; i++) {
      if (i < 10) {
        i = ("0" + i).slice(-2);
      }

      $('.select-minute').append('<option value="' + i + '">' + i + '</option>');
      $('.select-second').append('<option value="' + i + '">' + i + '</option>');
    }

    $(".required").change(function() {
      $(this).css("color", checkRequired($(this)));
      $(this).css("border-bottom-color", checkRequired($(this)));
    });

    $(".optional").change(function() {
      $(this).css("color", checkOptional($(this)));
      $(this).css("border-bottom-color", checkOptional($(this)));
    });

    $(".optional-num").change(function() {
      $(this).css("color", checkOptionalNum($(this)));
      $(this).css("border-bottom-color", checkOptionalNum($(this)));
    });

    $('#add-event').click(function() {
      addData();
      getAllRows();
    });

    $('#edit-event').click(pushEdits);
    $('input').change(pushEdits);
    $('select').change(pushEdits);

    $('#show-add-event').click(function() {
      $('.new-event-element').css('display', 'inline-block');
      $('.edit-event-element').css('display', 'none');
      $('#show-edit-event').removeClass('current-mode');
      $('#show-add-event').addClass('current-mode');

      clearFields();
    });

    $('#show-edit-event').click(function() {
      $('.edit-event-element').css('display', 'inline-block');
      $('.new-event-element').css('display', 'none');
      $('#show-edit-event').addClass('current-mode');
      $('#show-add-event').removeClass('current-mode');

      clearFields();
      getAllRows();
    });
  });

  $(document).on('click', '.edit-select-row', function() {
    clearFields();
    getRowData(parseInt($(this).attr('id').substring(4)));
    $('.edit-select-list').children('.edit-select-row').each(function(i) {
      $(this).removeClass('selected');
    })
    currentRowID = $(this).attr('id');
    $(this).addClass('selected');
  });

  $(document).on('click', '#add-row', function() {
    startNewRow();
  });

  function checkRequired(element) {
    if (element.val() == "") {
      return gray;
    }

    if (Number.isInteger(parseInt(element.val()))) {
      return green;
    }

    return red;
  }

  function checkOptional(element) {
    if (element.val() == "") {
      return gray;
    }

    return green;
  }

  function checkOptionalNum(element) {
    if (element.val() == "") {
      return gray;
    }

    return Number.isInteger(parseInt(element.val())) ? green : red;
  }

  function resetInputColors() {
    $('form').find('.required').css('color', '#000');
    $('form').find('.optional').css('color', '#000');
    $('form').find('.optional-num').css('color', '#000');
  }

  function getFields() {
      var startYear = Number.isInteger(parseInt($('input[name=start-year]').val())) ? $('input[name=start-year]').val() : "",
          startMonth = $('input[name=start-month]').val(),
          startDay = $('input[name=start-day]').val();

      var startTime = "";

      if ($('select[name=start-hour]').val() &&
          $('select[name=start-minute]').val() &&
          $('select[name=start-second]').val()) {

          startTime = $('select[name=start-hour]').val() + ':' +
                      $('select[name=start-minute]').val() + ':' +
                      $('select[name=start-second]').val();
          }

      var endYear = $('input[name=end-year]').val(),
          endMonth = $('input[name=end-month]').val(),
          endDay = $('input[name=end-day]').val();

      var endTime = "";

      if ($('select[name=end-hour]').val() &&
          $('select[name=end-minute]').val() &&
          $('select[name=end-second]').val()) {

          endTime = $('select[name=end-hour]').val() + ':' +
                    $('select[name=end-minute]').val() + ':' +
                    $('select[name=end-second]').val();
          }


      var displayDate = $('input[name=display-date]').val(),
          headline = $('input[name=headline]').val(),
          text = $('input[name=text]').val(),
          display = $('input[name=display-date]').val(),
          media = $('input[name=media]').val(),
          credit = $('input[name=media-credit]').val(),
          caption = $('input[name=media-caption]').val(),
          thumb = $('input[name=media-thumb]').val(),
          type = $('input[name=type]').val(),
          group = $('input[name=group]').val(),
          background = $('input[name=backgrounf]').val();

      return [startYear,
              startMonth,
              startDay,
              startTime,
              endYear,
              endMonth,
              endDay,
              endTime,
              displayDate,
              headline,
              text,
              media,
              credit,
              caption,
              thumb,
              type,
              group,
              background];
  }

  function addData() {
      this.disabled = true;

      google.script.run
          .withSuccessHandler(
            function(msg, element) {
              $('#submit-bar').val("New row added");
              element.disabled = false;
              clearFields();
            })
          .withFailureHandler(
            function(msg, element) {
              showError(msg, $('#submit-bar'));
              element.disabled = false;
            })
          .withUserObject(this)
          .appendData(getFields());
  }

  function getRowData(row) {
    actualRow = row + 2
    // console.log('getting row ' + actualRow);

    google.script.run
      .withSuccessHandler(function(data) {
        $("input[name=start-year]").val(data[0]);
        $("input[name=start-month]").val(data[1]);
        $("input[name=start-day]").val(data[2]);
        $("select[name=start-hour]").val(data[3].substring(0, 2));
        $("select[name=start-minute]").val(data[3].substring(3, 5));
        $("select[name=start-second]").val(data[3].substring(6, 8));

        $("input[name=end-year]").val(data[4]);
        $("input[name=end-month]").val(data[5]);
        $("input[name=end-day]").val(data[6]);
        $("select[name=end-hour]").val(data[7].substring(0, 2));
        $("select[name=end-minute]").val(data[7].substring(3, 5));
        $("select[name=end-second]").val(data[7].substring(6, 8));

        $("input[name=display-date]").val(data[8]);
        $("input[name=headline]").val(data[9]);
        $("input[name=text]").val(data[10]);
        $("input[name=media]").val(data[11]);
        $("input[name=media-credit]").val(data[12]);
        $("input[name=media-caption]").val(data[13]);
        $("input[name=media-thumb]").val(data[14]);
        $("input[name=type]").val(data[15]);
        $("input[name=group]").val(data[16]);
        $("input[name=background]").val(data[17]);
      })
      .withFailureHandler(
        function(msg, element) {
          showError(msg, $('#submit-bar'));
      })
      .getRowData(actualRow);
  }

  function pushEdits() {
      google.script.run
          .withSuccessHandler(
            function(msg, element) {
              $('#submit-bar').val("New row added");
            })
          .withFailureHandler(
            function(msg, element) {
              showError(msg, $('#submit-bar'));
            })
          .withUserObject(this)
          .editData(getFields());
  }

  function clearFields() {
    resetInputColors();
    $('form').find('input:text').val('');
    $('form').find('input:text').css('border-bottom', 'solid 2px ' + gray);

    $('.select-hour').val('');
    $('.select-minute').val('');
    $('.select-second').val('');
  }

  function showError(msg, element) {
    var div = $('<div id="error" class="error">' + msg + '</div>');
    $(element).after(div);
  }

  function removeOldRows() {
    $('li').remove('.edit-select-row');
    $('li').remove('#add-row');
  }

  function getAllRows() {
    google.script.run
      .withSuccessHandler(
        function(rows) {
          removeOldRows();

          for (var i = 0; i < rows.length; i++) {
            $('.edit-select-list').append('<li class="edit-select-row" id="row-' + i + '">' + rows[i] + '</li>');
          }

          $('.edit-select-list').append('<li id="add-row">+ Add Row</li>');
        })
      .withFailureHandler(
        function(msg, element) {
          showError(msg, $('#submit-bar'));
        })
      .withUserObject(this)
      .getAllRows();
  }

  function startNewRow() {
    google.script.run
      .withSuccessHandler(
        function(msg, element) {
          clearFields();
        })
      .withFailureHandler(
        function(msg, element) {

        })
      .withUserObject(this)
      .startNewRow();
  }

  </script>

</body>

</html>
